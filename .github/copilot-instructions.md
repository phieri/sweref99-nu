# Copilot Instructions for sweref99-nu

## Repository Overview
This is a Swedish Progressive Web App (PWA) that shows GPS coordinates in SWEREF 99 TM format. It's a lightweight web application for Swedish coordinate system conversion.

## Technology Stack
- **Frontend**: TypeScript, HTML, CSS with Pico.css framework
- **Build**: TypeScript compiler, Make for build orchestration

## Key Files
- `src/script.ts` - Main TypeScript application logic
- `_site/index.html` - Main HTML page
- `_site/sw.js` - ServiceWorker for offline caching (increment CACHE_VERSION on changes!)
- `tsconfig.json` - TypeScript configuration
- `Makefile` - Build configuration
- `.github/workflows/ci.yml` - CI/CD pipeline

## Development Commands

### Quick Development (TypeScript only)
```bash
# Build TypeScript (fast ~1.5s)
make script.js
# or directly:
tsc
```

## Important Notes
- **TypeScript build is fast and reliable** - use for quick development
- **App works without JavaScript** but coordinate transformation will be missing and therefore not useful
- **Swedish language** - UI and comments are in Swedish
- **Target audience**: Swedish users needing their SWEREF 99 TM coordinates on mobile devices

## Development Workflow
1. Make TypeScript changes in `src/script.ts`
2. Test with `tsc` for quick validation
3. HTML/CSS changes can be tested directly in `_site/`

## Testing
- Manual testing via web browser
- Geolocation API requires HTTPS or localhost
- Test with Swedish coordinates (lat: 55-69, lon: 10-24)
- No automated test suite - testing is manual and browser-based

## Code Style and Formatting
- **Indentation**: Tabs (as defined in `.editorconfig`)
- **Line endings**: LF (Unix-style)
- **Charset**: UTF-8
- **Comments**: Swedish language for app logic, can be English for technical/build comments
- **Final newline**: Required in all files
- **YAML files**: Use spaces for indentation (2 spaces)

## Dependencies Management
- **Runtime dependencies** (loaded from CDN during CI/CD):
  - `proj4.js` (v2.19.10) - Coordinate transformation library
  - `pico.min.css` (v2.0.0) - CSS framework
- **Build dependencies**:
  - TypeScript (v5.9.2) - Installed globally via npm
- Dependencies are downloaded during CI/CD pipeline, not committed to repo
- See `SBOM-README.md` for complete Software Bill of Materials

## File Structure
```
├── .github/
│   ├── copilot-instructions.md  # This file
│   └── workflows/ci.yml          # CI/CD pipeline
├── _site/                        # Built output (deployed to GitHub Pages)
│   ├── index.html                # Main app page
│   ├── om.html                   # Help/about page
│   ├── sw.js                     # ServiceWorker (increment CACHE_VERSION!)
│   ├── stil.css                  # Custom styles
│   ├── script.js                 # Compiled TypeScript (generated)
│   ├── script.js.map             # Source maps (generated)
│   ├── proj4.js                  # Downloaded during CI (ignored in git)
│   ├── pico.min.css              # Downloaded during CI (ignored in git)
│   └── [icons]                   # PWA icons (generated from src/icon.svg)
├── src/
│   ├── script.ts                 # Main application logic
│   └── icon.svg                  # Source icon for PWA
├── Makefile                      # Build automation
├── tsconfig.json                 # TypeScript configuration
└── .editorconfig                 # Editor formatting rules
```

## Build Artifacts and Git Ignore
- `_site/script.js` and `_site/script.js.map` - Generated by TypeScript, ignored in git
- `_site/proj4.js` and `_site/pico.min.css` - Downloaded from CDN during CI, ignored in git
- `.tsbuildinfo` - TypeScript incremental build cache, ignored in git
- Icons in `_site/` are committed (generated with `make icons`)

## Common Pitfalls and Gotchas
- **ITRF/ETRS89 drift correction**: The app automatically corrects for continental drift between WGS84 (ITRF) and SWEREF 99 (ETRS89) based on current date
- **Coordinate validation**: Always check if coordinates are within Sweden (lat: 55-69, lon: 10-24)
- **Browser permissions**: Geolocation API requires user permission and HTTPS/localhost
- **Swedish language**: All user-facing text and most comments are in Swedish
- **No backend**: All coordinate transformation happens client-side using proj4.js
- **PWA support**: App works offline after first visit (service worker via manifest)

## ServiceWorker Cache Version Management
**CRITICAL**: The ServiceWorker cache version MUST be incremented whenever any user-facing changes are made to the app. This is essential for users to see updates.

### When to Increment Cache Version
Increment the `CACHE_VERSION` in `_site/sw.js` whenever you make changes to:
- **Any HTML files** (`index.html`, `om.html`)
- **Any CSS files** (`stil.css`, `pico.min.css`)
- **JavaScript/TypeScript** (`script.ts` → `script.js`)
- **External dependencies** (proj4.js version updates)
- **PWA resources** (icons, manifest)
- **Any other files that are cached by the ServiceWorker**

### How to Increment Cache Version
1. Open `_site/sw.js`
2. Find line with `const CACHE_VERSION = 'v2';` (or current version)
3. Increment the version number: `'v2'` → `'v3'`, `'v3'` → `'v4'`, etc.
4. **ALWAYS include this change in your PR** when making any user-facing modifications

### Why This Matters
- Users who have visited the app before have a cached version
- Without incrementing the cache version, they will continue seeing the old version
- The ServiceWorker will only fetch new resources when `CACHE_VERSION` changes
- Old cache is automatically cleaned up when a new version is activated

### Example
If you're fixing a bug in `script.ts` or updating text in `index.html`:
```javascript
// Before
const CACHE_VERSION = 'v2';

// After
const CACHE_VERSION = 'v3';
```

**Remember**: This is one of the most commonly forgotten steps. Always check if you need to update the cache version before finalizing your changes.

## CI/CD Pipeline
- Triggered on push/PR to main branch (except .md files)
- Steps:
  1. Install TypeScript globally
  2. Build TypeScript with `make script.js`
  3. Download proj4.js and pico.min.css from CDN
  4. Deploy to GitHub Pages
- No linting step (consider adding if code quality issues arise)
